<!-- TITLE: M121 -->
<!-- SUBTITLE: M121 Aggregation -->

# Reference Database
`mongo "mongodb://cluster0-shard-00-00-jxeqq.mongodb.net:27017,cluster0-shard-00-01-jxeqq.mongodb.net:27017,cluster0-shard-00-02-jxeqq.mongodb.net:27017/aggregations?replicaSet=Cluster0-shard-0" --authenticationDatabase admin --ssl -u m121 -p aggregations --norc`

Aggregattoin quick reference: https://docs.mongodb.com/manual/meta/aggregation-quick-reference/
# pipelines
Data is processed in a composition of stages, to filter and transform. Called pipleines, after the UNIX pipe. Run on the server not the client (driver).

```
db.userColl.agreegate([
	{ < stage 1 > },
	{ < stage 1 > },
	...
], options)
```

# Operators
`$match`, `$group` and `$project` are aggreation operators;. they must appear as the start of each stage.

`$gte` and `$in` are query operators.

# Expressions
Expressions are a lot like functions; they always appear in a "value" position. They provide additional document properties. Expressions may take a single argument or an array of arguments.

e.g. (where `<gravityOnEarth>` and `<weightOnEarth>` are fixed values. :
```
	myWeight: { $multiply: [$divide: [ "$gravity.value", <gravityOnEarth>], <weightOnEarth>] } }
```

# Variables
`$` prefixed names are field paths in the documents presented to that stage; that includes any new fields added by previous stages from expressions.

There are a few system variables and they are always in uppercase, e.g. `$$CURRENT` (current document).

And finally there are user varaibles, having a `$$` prefix too (for convention, do not use uppercase user variables).
 
 
 # $match (filter)
 https://docs.mongodb.com/manual/reference/operator/aggregation/match/
 
 Some come as early in stages as possible, and can be repeated many times in a single aggregation. Uses the standard MongoDB query syntax.
 
 Cannot use the `$where` operator.
 
 If using `$text` operator, then it must be the first stage in the piepline.
 
 # $project
 `$project` operator is much more powerful than that available i n the `find` operator. As an aggregation operator, `$project` can return expressions, which can create new fields. Should be used aggresively to keep document set as small as possible. Can be used in as many stages are required.
 
 "object.paths" must be withon quotes. If assigning an "object.path" to another document property, must prefix "$" on the right hand side of the assignment:
 ```
 {
	 $project: {
		 _id:0,
		 gravity: "$gravity.value",
		 myWeight: { $multiply: [$divide: [ "$gravity.value", 9.8], 72] } }
	 }
 }
 ```

  
 # Exercises
 ## $match:
 
 ```
 
db.movies.aggregate([
	{
		$match: {
			"imdb.rating": { $gte: 7 },
			"rated": { $in: ["PG", "G"] },
			"languages": { $all: ["English", "Japanese"] },
			"genres": { $nin: ["Crime", "Horror"] },
		}
	}
]).itcount();



var pipeline = [
	{
		$match: {
			"imdb.rating": { $gte: 7 },
			"rated": { $in: ["PG", "G"] },
			"languages": { $all: ["English", "Japanese"] },
			"genres": { $nin: ["Crime", "Horror"] },
		}
	}
];
```

## $project with expressions
```
db.movies.aggregate([
	{
		$project: {
			_id: 0,
			title: 1,
			titleSplit: { $split: [ "$title", " "]},
		}
	},
	{
		$project: {
			title: 1,
			titleSplit: 1,
			numberOfWords: { $cond: { if: { $isArray: "$titleSplit" }, then: { $size: "$titleSplit" }, else: 1} },
		}
	},
	{
		$match: {
			numberOfWords: 1
		}
	}
]);
```